@page "{guild?}/autopurge"
@using Database.Data
@using Discord.Rest
@model UtiliSite.Pages.Dashboard.AutopurgeModel
@{
    if (ViewData["guild"] == null) { return; }

    Layout = "Shared/_Layout.cshtml";
    ViewData["Title"] = "Autopurge - Utili Dashboard";

    bool premium = (bool) ViewData["premium"];

    ViewData["heading"] = "Autopurge";
    ViewData["subheading"] = "Automatically delete messages";

    if (premium) { ViewData["detailed"] = "Every channel is purged once per 10 seconds.\nMessages are deleted when they're older than the timespan you set, or when they are 500 messages up in the channel."; }
    else { ViewData["detailed"] = "One channel is purged every 30 seconds.\nMessages are deleted when they're older than the timespan you set, or when they are 100 messages up in the channel.\nGet premium to upgrade this feature."; }

    List<AutopurgeRow> rows = (List<AutopurgeRow>) ViewData["autopurgeRows"];
    List<RestTextChannel> channels = (List<RestTextChannel>) ViewData["channels"];
    List<RestTextChannel> nonAutopurgeChannels = (List<RestTextChannel>) ViewData["nonAutopurgeChannels"];
}

<div class="dropdown">
    <button class="btn btn-secondary dropdown-toggle dropdown-200" type="button" data-toggle="dropdown" id="dropdownAddChannel" aria-haspopup="true" aria-expanded="false">
        Autopurge channel...
    </button>
    <div class="dropdown-menu dropdown-200-content noverticalpadding" aria-labelledby="dropdownAddChannel">

        @foreach (RestTextChannel channel in nonAutopurgeChannels)
        {
            <form method="post" name="noajax">
                <input type="hidden" name="channel" value="@channel.Id" />
                <button class="dropdown-item" asp-page-handler="Add" type="submit">@channel.Name</button>
            </form>
        }

    </div>
</div>

<div class="row">
    @foreach (AutopurgeRow row in rows)
    {
        string channelName = channels.First(x => x.Id == row.ChannelId).Name;
        <div>
            <div class="col-md-12" style="padding-bottom: 30px;">
                <div class="card-container-3">
                    <form method="post">

                        <input type="hidden" name="channel" value="@row.ChannelId" />

                        <div class="input-group flex-nowrap">

                            <input type="text" class="form-control card-strong card-component-3 card-heading" value="@channelName" readonly>

                            <button type="submit" name="noajax" asp-page-handler="Remove" class="btn card-button-x card-strong">
                                <svg width="38px" height="38px" viewBox="0 0 16 16" class="bi bi-x" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path transform="translate(0.4, 0)" fill-rule="evenodd" d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </button>

                        </div>

                        <div class="input-group flex-nowrap">
                            <span class="input-group-prepend input-group-text card-component-1">Threshold</span>
                            <input type="text" name="timespan" class="form-control card-component-2" value="@row.Timespan">
                        </div>

                        <div class="input-group flex-nowrap">
                            <span class="input-group-prepend input-group-text card-component-1">Mode</span>
                            <select class="custom-select card-component-2" name="mode">
                                <!option value="0" @AutopurgeModel.GetIsSelected(0, row)>All messages</!option>
                                <!option value="1" @AutopurgeModel.GetIsSelected(1, row)>Bot messages</!option>
                                <!option value="2" @AutopurgeModel.GetIsSelected(2, row)>Disabled</!option>
                            </select>
                        </div>

                        <div class="input-group flex-nowrap">
                            <span class="input-group-prepend input-group-text card-component-2 card-strong"></span>
                            <button type="submit" class="btn  card-component-1 card-button card-strong">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }
</div>
